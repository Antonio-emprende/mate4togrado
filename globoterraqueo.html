<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Matem√°ticas 4.¬∫ ‚Äì Globo terr√°queo (Paralelos y meridianos)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  :root{
    --azul:#2563eb; --verde:#10b981; --rojo:#ef4444; --morado:#7c3aed;
    --gris:#f1f5f9; --borde:#e2e8f0; --texto:#0f172a;
    --radius:18px; --shadow:0 10px 28px rgba(2,6,23,.08);
  }
  body{background:linear-gradient(180deg,#f8fbff 0%,#ffffff 100%);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--texto)}
  .game-card{border:none;border-radius:1rem;box-shadow:var(--shadow)}
  .title-badge{background:linear-gradient(90deg,var(--azul),var(--verde));-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:800}
  .score-chip{font-weight:800;border-radius:999px;padding:.45rem .95rem;background:#eef7ff;color:#0d47a1;border:1px solid #d7ebff}
  .btn-fab{border-radius:999px;padding:.65rem 1rem;font-weight:700;box-shadow:0 6px 20px rgba(30,136,229,.25)}

  /* Etiquetas arrastrables */
  .piece{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:140px;
         background:#fff;border:2px solid var(--borde);border-radius:14px;padding:.6rem .8rem;
         cursor:grab;user-select:none;touch-action:none;box-shadow:0 8px 22px rgba(2,6,23,.06)}
  .piece:active{cursor:grabbing;transform:scale(1.04)}
  .piece .name{font-weight:800;font-size:.95rem;text-align:center}
  .dragging{position:fixed;z-index:1000;pointer-events:none;filter:drop-shadow(0 10px 16px rgba(0,0,0,.25))}

  /* Greenwich vertical SOLO en el globo */
  .piece.vertical{
    writing-mode: vertical-rl;
    text-orientation: mixed;
    min-width: auto;
    padding: .4rem .5rem;
  }
  .piece.vertical .name{white-space:nowrap}

  .bank{min-height:120px;background:#fff;border:2px solid var(--borde);border-radius:var(--radius);
        padding:10px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center}

  /* Globo (20% m√°s grande) */
  .globe-wrap{position:relative;max-width:504px;margin:auto}
  .globe{width:100%;height:auto;display:block;pointer-events:none}

  /* Zonas amplias de soltado (bandas) */
  .hotzone{position:absolute; transform:translate(-50%,-50%);
           border:2px dashed rgba(124,58,237,.35); border-radius:10px; pointer-events:auto; z-index:3}
  .hotzone.h-par{ width:82%; height:34px; left:50%; top:50%; }   /* banda horizontal Ecuador */
  .hotzone.h-mer{ width:34px; height:82%; left:50%; top:50%; }   /* banda vertical Greenwich */
  .hot{ outline:3px solid rgba(124,58,237,.45); outline-offset:6px; }

  /* Pines visibles (se mueven cada ronda, en %) */
  .target-pin{position:absolute;width:14px;height:14px;border-radius:50%;background:#10b981;
              box-shadow:0 2px 6px rgba(0,0,0,.18);transform:translate(-50%,-50%);z-index:2}
  .target-pin.pin-ecu{background:#ef4444}
  .target-pin.pin-gre{background:#22c55e}

  /* Etiquetas colocadas sobre el globo */
  .on-globe{position:absolute;z-index:4}

  .section{border:1px solid var(--borde);border-radius:16px;padding:14px;background:#fff}
  .section h3{font-size:1.05rem;margin-bottom:.35rem}

  @media (max-width:576px){ .piece{min-width:130px} }

  /* Bot√≥n ‚ÄúMen√∫ principal‚Äù peque√±o (abajo a la derecha) */
  .btn-main-return{
    background:#ef4444; color:#fff; border:none; border-radius:999px;
    padding:.48rem .9rem; font-weight:800; box-shadow:0 8px 18px rgba(239,68,68,.30);
    /* Parpadeo visible (opacidad) */
    animation:pulseBlink 1.1s ease-in-out infinite;
  }
  @keyframes pulseBlink{
    0%,100%{ opacity:1; transform:translateY(0); }
    50%{ opacity:.45; transform:translateY(-1px); }
  }
</style>
</head>
<body>
<div class="container py-4 py-md-5">
  <div class="row justify-content-center">
    <div class="col-12 col-xl-10">
      <div class="card game-card">
        <div class="card-body p-3 p-md-4 p-lg-5">

          <header class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-3">
            <div>
              <h1 class="h3 m-0 title-badge">Matem√°ticas 4.¬∫ ‚Äì Globo terr√°queo</h1>
              <p class="text-secondary m-0">Ubica el <strong>paralelo Ecuador</strong> (horizontal) y el <strong>meridiano de Greenwich</strong> (vertical).</p>
            </div>
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <span id="score" class="score-chip" aria-live="polite">Puntaje: 0 / 100</span>
              <button id="howBtn" class="btn btn-outline-secondary btn-fab" type="button">‚ùì ¬øC√≥mo jugar?</button>
              <button id="checkBtn" class="btn btn-success btn-fab" type="button">‚úîÔ∏è Revisar</button>
              <button id="resetBtn" class="btn btn-primary btn-fab" type="button">üîÑ Nueva ronda</button>
            </div>
          </header>

          <div class="row g-3">
            <div class="col-12 col-lg-5">
              <div class="section">
                <h3>Etiquetas</h3>
                <p class="text-secondary small mb-2">Arrastra cada etiqueta al lugar correcto del globo.</p>
                <div id="bank-globe" class="bank"></div>
              </div>
            </div>

            <div class="col-12 col-lg-7">
              <div class="section">
                <h3>Globo con rejilla (paralelos y meridianos)</h3>
                <div class="globe-wrap" id="wrap">
                  <svg id="globe" class="globe" viewBox="0 0 300 300" aria-label="Globo">
                    <defs><clipPath id="c"><circle cx="150" cy="150" r="120"></circle></clipPath></defs>
                    <circle cx="150" cy="150" r="120" fill="#e0f2fe" stroke="#94a3b8" stroke-width="2"/>
                    <g clip-path="url(#c)" stroke-width="1.6" fill="none">
                      <!-- Paralelos (rojo) -->
                      <g stroke="#ef4444">
                        <line x1="30" y1="60"  x2="270" y2="60"/>
                        <line x1="30" y1="90"  x2="270" y2="90"/>
                        <line x1="30" y1="120" x2="270" y2="120"/>
                        <line x1="30" y1="150" x2="270" y2="150"/> <!-- Ecuador -->
                        <line x1="30" y1="180" x2="270" y2="180"/>
                        <line x1="30" y1="210" x2="270" y2="210"/>
                        <line x1="30" y1="240" x2="270" y2="240"/>
                      </g>
                      <!-- Meridianos (verde) -->
                      <g stroke="#22c55e">
                        <line x1="60"  y1="30" x2="60"  y2="270"/>
                        <line x1="90"  y1="30" x2="90"  y2="270"/>
                        <line x1="120" y1="30" x2="120" y2="270"/>
                        <line x1="150" y1="30" x2="150" y2="270"/> <!-- Greenwich -->
                        <line x1="180" y1="30" x2="180" y2="270"/>
                        <line x1="210" y1="30" x2="210"  y2="270"/>
                        <line x1="240" y1="30" x2="240" y2="270"/>
                      </g>
                    </g>
                  </svg>

                  <!-- Zonas amplias para soltar -->
                  <div id="zone-paralelos" class="hotzone h-par" title="Banda del Ecuador"></div>
                  <div id="zone-greenwich" class="hotzone h-mer" title="Banda de Greenwich"></div>

                  <!-- Pines (en %) -->
                  <div id="pin-ecu" class="target-pin pin-ecu" title="Ecuador"></div>
                  <div id="pin-gre" class="target-pin pin-gre" title="Greenwich"></div>
                </div>

                <div class="hint text-muted mt-2">
                  <strong>Paralelo</strong> = horizontal (latitud). <strong>Meridiano</strong> = vertical (longitud).
                </div>
              </div>
            </div>
          </div>

          <div class="mt-3 small text-muted">Consejo: si una pieza vuelve al banco es que no pertenece a esa zona. ¬°Sigue intentando! üòä</div>

          <!-- Bot√≥n peque√±o abajo a la derecha -->
          <div class="d-flex justify-content-end mt-2">
            <button id="mainMenuBtn" class="btn-main-return">‚Üê Men√∫ principal</button>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal ¬øC√≥mo jugar? -->
<div class="modal fade" id="howModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header border-0">
        <h5 class="modal-title">¬øC√≥mo se juega?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <ol class="mb-0 ps-3">
          <li>Arrastra <strong>Ecuador</strong> y <strong>Greenwich</strong> a su banda correspondiente.</li>
          <li>Si sueltas cerca del pin correcto, la etiqueta se <em>empotra</em> sola.</li>
          <li>Usa <strong>‚úîÔ∏è Revisar</strong> y <strong>Nueva ronda</strong> para reintentar.</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<!-- Modal resultado -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-2 p-md-3">
      <div class="modal-header border-0 justify-content-center">
        <div style="font-size:48px">üéâ‚ú®</div>
      </div>
      <div class="modal-body">
        <h3 id="resultTitle" class="mb-2">¬°Excelente!</h3>
        <p id="resultText" class="lead mb-0"></p>
      </div>
      <div class="modal-footer border-0 justify-content-center">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Seguir practicando</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";

  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  let score = 0, celebrated = false;

  function setScore(v){ score = Math.round(v); $('#score').textContent = `Puntaje: ${score} / 100`; }
  function shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }

  /* ===== Datos etiquetas ===== */
  const LABELS = [
    {id:'lbl-ecu', name:'Ecuador (paralelo)',     accept:'zone-paralelos'},
    {id:'lbl-gre', name:'Greenwich (meridiano)',  accept:'zone-greenwich'}
  ];

  /* ===== Banco ===== */
  function renderBank(){
    const bank = $('#bank-globe'); bank.innerHTML='';
    shuffle(LABELS).forEach(g=>{
      const tag = document.createElement('div');
      tag.className='piece';
      tag.dataset.accept=g.accept;
      tag.innerHTML = `<div class="name">${g.name}</div>`;
      makeDraggable(tag);
      bank.appendChild(tag);
    });
  }

  /* ===== Pines (se reubican en %) ===== */
  function randomizePins(){
    const pinE = $('#pin-ecu');
    const pinG = $('#pin-gre');

    // Ecuador: y 50% (l√≠nea horizontal), x 18‚Äì82%
    const xE = 18 + Math.random()*64;
    pinE.style.left = xE + '%';
    pinE.style.top  = '50%';

    // Greenwich: x 50% (l√≠nea vertical), y 16‚Äì84%
    const yG = 16 + Math.random()*68;
    pinG.style.left = '50%';
    pinG.style.top  = yG + '%';
  }

  /* ===== Util ===== */
  function distanceTo(el, x, y){
    const r = el.getBoundingClientRect();
    const cx = r.left + r.width/2;
    const cy = r.top  + r.height/2;
    return Math.hypot(x-cx, y-cy);
  }
  function elementAt(x,y){ return document.elementFromPoint(x,y); }

  /* ===== Drag & Drop ===== */
  function makeDraggable(src){
    src.addEventListener('pointerdown', (e)=>{
      e.preventDefault();                 // evita seleccionar texto
      const ghost = src.cloneNode(true);  // fantasma
      ghost.classList.add('dragging');
      document.body.appendChild(ghost);

      const r = ghost.getBoundingClientRect();
      const offX = r.width/2, offY = r.height/2;
      const moveAt = (x,y)=>{ ghost.style.left=(x-offX)+'px'; ghost.style.top=(y-offY)+'px'; };
      moveAt(e.clientX,e.clientY);

      function onMove(ev){ moveAt(ev.clientX,ev.clientY); highlight(ev.clientX,ev.clientY); }
      function onUp(ev){
        document.removeEventListener('pointermove',onMove);
        document.removeEventListener('pointerup',onUp);
        drop(ev.clientX,ev.clientY, src);
        ghost.remove(); clearHighlights();
      }

      document.addEventListener('pointermove', onMove, {passive:true});
      document.addEventListener('pointerup', onUp, {once:true});
    });
  }

  function highlight(x,y){
    clearHighlights();
    const el = elementAt(x,y);
    const zone = (el && (el.id==='zone-paralelos' || el.id==='zone-greenwich')) ? el
              : (el && el.closest ? el.closest('.hotzone') : null);
    if(zone) zone.classList.add('hot');
  }
  function clearHighlights(){ $$('.hotzone').forEach(z=>z.classList.remove('hot')); }

  function drop(x,y, src){
    const el = elementAt(x,y);
    const zone = (el && (el.id==='zone-paralelos' || el.id==='zone-greenwich')) ? el
              : (el && el.closest ? el.closest('.hotzone') : null);

    const must = src.dataset.accept;

    // Tolerancia al pin correcto (empotrado seguro)
    const TOL = 56; // px
    const nearE = distanceTo($('#pin-ecu'), x, y) <= TOL;
    const nearG = distanceTo($('#pin-gre'), x, y) <= TOL;

    const isCorrectByBand = zone && (zone.id === must);
    const isCorrectByPin  = (must==='zone-paralelos'  && nearE) || (must==='zone-greenwich' && nearG);

    if(isCorrectByBand || isCorrectByPin){
      snapOnGlobe(src, must);
      src.dataset.correct='1';
      computeScore();
      return;
    }

    // Incorrecto: regresa al banco (y queda horizontal)
    $('#bank-globe').appendChild(src);
    src.classList.remove('on-globe','vertical');
    src.style.left = src.style.top = '';
    src.dataset.correct='0';
    computeScore();
    bounce(src);
  }

  function snapOnGlobe(src, must){
    const wrap = $('#wrap').getBoundingClientRect();
    const pin  = (must==='zone-paralelos') ? $('#pin-ecu') : $('#pin-gre');
    const pr   = pin.getBoundingClientRect();

    // Offset ‚Äúbonito‚Äù relativo al pin (diferente para cada etiqueta)
    const dx = (must==='zone-paralelos') ? 24 : 18;
    const dy = (must==='zone-paralelos') ? -10 : 24;

    const x = pr.left + pr.width/2 + dx - wrap.left;
    const y = pr.top  + pr.height/2 + dy - wrap.top;

    const container = $('#wrap');
    src.classList.add('on-globe');
    if(must==='zone-greenwich'){ src.classList.add('vertical'); } else { src.classList.remove('vertical'); }

    container.appendChild(src);
    src.style.left = x + 'px';
    src.style.top  = y + 'px';
  }

  function bounce(el){
    el.animate([{transform:'translateY(0)'},{transform:'translateY(-6px)'},{transform:'translateY(0)'}],
               {duration:180,iterations:2});
  }

  /* ===== Puntaje / resultado ===== */
  function computeScore(){
    const total = LABELS.length; // 2
    let ok = 0;
    $$('.piece').forEach(p=>{ if(p.dataset.correct==='1') ok++; });
    const val = (ok/total)*100;
    setScore(val);
    if(val===100 && !celebrated){ confetti(); celebrated=true; }
  }

  function checkAll(){
    const total = LABELS.length; let ok = 0;
    $$('.piece').forEach(p=>{
      if(p.dataset.correct==='1'){ ok++; p.style.boxShadow='0 0 0 2px #86efac inset'; }
      else { p.style.boxShadow='0 0 0 2px #fecaca inset'; }
    });
    const val=(ok/total)*100; setScore(val);
    const t=$('#resultTitle'), txt=$('#resultText');
    if(val===100){ t.textContent='¬°Has ganado!'; txt.textContent='¬°Sacaste un 100! üòä'; }
    else if(val>=70){ t.textContent='¬°Muy bien!'; txt.textContent=`Tu puntaje fue ${val.toFixed(0)} / 100. Revisa piezas en rojo y vuelve a intentar.`; }
    else { t.textContent='¬°T√∫ puedes!'; txt.textContent=`Tu puntaje fue ${val.toFixed(0)} / 100. Practica un poquito m√°s.`; }
    if(window.bootstrap){ new bootstrap.Modal('#resultModal').show(); } else { alert(`${t.textContent}\n${txt.textContent}`); }
  }

  function confetti(){
    const burst=document.createElement('div'); burst.style.position='fixed'; burst.style.inset='0';
    burst.style.pointerEvents='none'; document.body.appendChild(burst);
    const emojis=['‚ú®','üéâ','‚≠ê','üéØ','üí´','üèÜ'];
    for(let i=0;i<60;i++){
      const s=document.createElement('div'); s.textContent=emojis[Math.floor(Math.random()*emojis.length)];
      s.style.position='absolute'; s.style.left=Math.random()*100+'%'; s.style.top='-10%';
      s.style.fontSize=(16+Math.random()*22)+'px'; s.style.transition='transform 1.3s ease, opacity 1.3s ease';
      burst.appendChild(s);
      requestAnimationFrame(()=>{ s.style.transform='translateY('+(120+Math.random()*120)+'vh) rotate('+(Math.random()*360)+'deg)'; s.style.opacity='0'; });
    }
    setTimeout(()=>burst.remove(),1400);
  }

  /* ===== Reset / inicio ===== */
  function resetGame(){
    celebrated=false; setScore(0);
    $$('.piece').forEach(p=>{
      p.dataset.correct=''; p.style.boxShadow=''; p.classList.remove('on-globe','vertical');
      p.style.left=''; p.style.top='';
      $('#bank-globe').appendChild(p);
    });
    randomizePins();
  }

  function init(){
    renderBank();
    randomizePins();
    setScore(0);
    $('#checkBtn').addEventListener('click', checkAll);
    $('#resetBtn').addEventListener('click', resetGame);
    $('#howBtn').addEventListener('click', ()=>{ if(window.bootstrap){ new bootstrap.Modal('#howModal').show(); } else { alert('Arrastra las etiquetas a su banda; si caes cerca del pin, se empotra sola.'); } });
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); }
  else{ init(); }

})();
</script>

<!-- Handler del bot√≥n Men√∫ principal -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('mainMenuBtn');
  if(btn){
    btn.addEventListener('click', () => {
      if (history.length > 1) history.back();
      else window.location.href = 'index.html';
    });
  }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
